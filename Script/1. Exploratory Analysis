## Libraries

library(gtsummary)
library(dplyr)
library(tidyr)
library(gtsummary)
library(DataExplorer)
library(ggplot2)

# Data load
load("ATP_final.RData")

## 1. Summary

summary(datos_combinados)

## 2. Variable characteristics

### tourney_name

n_distinct(datos_combinados$tourney_name)
n_distinct(datos_combinados$tourney_id)

### Surface

unique(datos_combinados$surface)
table(datos_combinados$surface)

### tourney_level and level

unique(datos_combinados$tourney_level)
table(datos_combinados$tourney_level)

### round

table(datos_combinados$round)

### minutes

table(is.na(datos_combinados$minutes))
n_distinct(datos_combinados$minutes)
mean(as.numeric(datos_combinados$minutes), na.rm = TRUE)
sd(as.numeric(datos_combinados$minutes), na.rm = TRUE)

### winner_id, loser_id

n_distinct(datos_combinados$winner_id)
n_distinct(datos_combinados$loser_id)

### winner/loser_entry

unique(datos_combinados$winner_entry)
unique(datos_combinados$loser_entry)

### hands 

unique(datos_combinados$winner_hand)
unique(datos_combinados$loser_hand)

### country

n_distinct(datos_combinados$winner_ioc)
n_distinct(datos_combinados$loser_ioc)

### Age

summary(datos_combinados$winner_age)
summary(datos_combinados$loser_age)
is.integer(datos_combinados$winner_rank)
summary(datos_combinados$dif_age)

### Ranking

missing_data_summary <- datos_combinados %>%
  filter(is.na(winner_rank)) %>%
  group_by(year) %>%
  summarize(missing_count = n())

# Plotting missing data per year
ggplot(missing_data_summary, aes(x = year, y = missing_count)) +
  geom_bar(stat = "identity", fill = "darkblue") +
  labs(title = "Missing Winner Rank Data by Year",
       x = "Year",
       y = "Count of Missing Winner Rank") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90))

### Summary 

tbl_summary(data = datos_combinados, include = c(surface, tourney_level, winner_hand, loser_hand, dif_age, winner_rank, loser_rank, dif_rank))

## 3. Report by PR and LL

tbl_summary(data = datos_combinados, by = PR, include = c(year, surface, tourney_level, winner_hand, loser_hand, dif_age, winner_rank, loser_rank, dif_rank))
tbl_summary(data = datos_combinados, by = LL, include = c(year, surface, tourney_level, winner_hand, loser_hand, dif_age, winner_rank, loser_rank, dif_rank))

## 4. Distributions

plot_histogram(datos_combinados)
plot_bar(datos_combinados)

## 5. Missing data

missing_per_column <- colSums(is.na(datos_combinados))
missing_percentage <- missing_per_column * 100 / nrow(datos_combinados) 
missing_percentage


missing_data <- data.frame(
  variable = names(datos_combinados),
  missing_count = colSums(is.na(datos_combinados)),
  total = nrow(datos_combinados)
)

missing_data$percentage <- missing_percentage

ggplot(missing_data, aes(x = reorder(variable, -percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  labs(title = "Missing data in each variable", 
       x = "Variable", 
       y = "Missing data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90))






