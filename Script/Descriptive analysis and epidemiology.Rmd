---
title: "Descriptive analysis"
author: "Ana Abad"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(compareGroups)

```



```{r}
load("ATP_final.RData")
```


# 1. Mean

```{r}
round(sapply((datos_combinados %>% select(where(is.numeric))), mean, na.rm = TRUE),4)
```





# 2. Percentages: LL and PR

Is not useful, because LL/PR includes matches in which at least one of the players has the condition, but does not include information when the other player is also a LL/PR. Also, since the entry is for the whole tournament, it doesn't reflect the data correctly when using matches as a measurement unit.

```{r}
table(datos_combinados$LL)
table(datos_combinados$PR)


table(datos_combinados$LL)["Yes"]*100/
  (table(datos_combinados$LL)["No"]+table(datos_combinados$LL)["Yes"])


table(datos_combinados$PR)["Yes"]*100/
  (table(datos_combinados$PR)["No"]+table(datos_combinados$PR)["Yes"])
  
```

## Prevalence PR by year

```{r}

PR_summary <- datos_combinados %>%
  group_by(year) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary <- PR_summary %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```




```{r}
PRI <- ggplot(PR_summary, aes(x = year, y = PR_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of protected ranking by Year with 95% Confidence Interval", 
       x = "Year", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.03)) 

PRI

```





## Prevalence of LL by year

```{r}

LL_summary <- datos_combinados %>%
  group_by(year) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary <- LL_summary %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```




```{r}
LLI <- ggplot(LL_summary, aes(x = year, y = LL_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by Year with 95% Confidence Interval", 
       x = "Year", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.1)) 

LLI

```


## Prevalence PR by level

```{r}

PR_summary_l <- datos_combinados %>%
  group_by(tourney_level) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_l <- PR_summary_l %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRlevel <- ggplot(PR_summary_l, aes(x = tourney_level, y = PR_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by level with 95% Confidence Interval", 
       x = "Year", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.01)) 

PRlevel

```


## Prevalence LL by level
```{r}

LL_summary_l <- datos_combinados %>%
  group_by(tourney_level) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_l <- LL_summary_l %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLlevel <- ggplot(LL_summary_l, aes(x = tourney_level, y = LL_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by level with 95% Confidence Interval", 
       x = "Year", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

LLlevel

```

## Prevalence PR by age

```{r}

PR_summary_a <- datos_combinados %>%
  group_by(dif_age) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_a <- PR_summary_a %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRage <- ggplot(PR_summary_a, aes(x = dif_age, y = PR_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Age difference", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.02)) 

PRage

```


## Prevalence LL by age

```{r}

LL_summary_a <- datos_combinados %>%
  group_by(dif_age) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_a <- LL_summary_a %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLage <- ggplot(LL_summary_a, aes(x = dif_age, y = LL_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Age difference", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

LLage

```

## PR by hand

### Winner
```{r}

PR_summary_hw <- datos_combinados %>%
  group_by(winner_hand) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_hw <- PR_summary_hw %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRwh <- ggplot(PR_summary_hw, aes(x = winner_hand, y = PR_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Winner Hand", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

PRwh

```
### Loser


```{r}

PR_summary_hl <- datos_combinados %>%
  group_by(loser_hand) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_hl <- PR_summary_hl %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRlh <- ggplot(PR_summary_hl, aes(x = loser_hand, y = PR_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Loser Hand", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

PRlh

```

## LL by hand
### Winner
```{r}

LL_summary_hw <- datos_combinados %>%
  group_by(winner_hand) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_hw <- LL_summary_hw %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLwh <- ggplot(LL_summary_hw, aes(x = winner_hand, y = LL_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Winner Hand", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

LLwh

```
### Loser


```{r}

LL_summary_hl <- datos_combinados %>%
  group_by(loser_hand) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_hl <- LL_summary_hl %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLlh <- ggplot(LL_summary_hl, aes(x = loser_hand, y = LL_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Loser Hand", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

LLlh

```

## PR by surface

```{r}

PR_summary_sur <- datos_combinados %>%
  group_by(surface) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_sur <- PR_summary_sur %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRsur <- ggplot(PR_summary_sur, aes(x = surface, y = PR_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Surface", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

PRsur

```

## LL by surface


```{r}

LL_summary_sur <- datos_combinados %>%
  group_by(surface) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_sur <- LL_summary_sur %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLsur <- ggplot(LL_summary_sur, aes(x = surface, y = LL_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "LLevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Surface", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

LLsur

```

## PR by country

### Winner
```{r}

PR_summary_cw <- datos_combinados %>%
  group_by(winner_ioc) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_cw <- PR_summary_cw %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRcw <- ggplot(PR_summary_cw, aes(x = winner_ioc, y = PR_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Winner ioc", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

PRcw

```
### Loser


```{r}

PR_summary_cl <- datos_combinados %>%
  group_by(loser_ioc) %>%
  summarise(
    PR_yes = sum(PR == "Yes"),
    PR_total = n(),
    PR_ratio = PR_yes / PR_total
  )

# 95 % CI

PR_summary_cl <- PR_summary_cl %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(PR_yes, PR_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
PRlc <- ggplot(PR_summary_cl, aes(x = loser_ioc, y = PR_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Loser ioc", 
       y = "Prevalence (PR = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 0.05)) 

PRlc

```


## LL by country

### Winner
```{r}

LL_summary_cw <- datos_combinados %>%
  group_by(winner_ioc) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_cw <- LL_summary_cw %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLcw <- ggplot(LL_summary_cw, aes(x = winner_ioc, y = LL_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Winner ioc", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 1)) 

LLcw

```
### Loser


```{r}

LL_summary_cl <- datos_combinados %>%
  group_by(loser_ioc) %>%
  summarise(
    LL_yes = sum(LL == "Yes"),
    LL_total = n(),
    LL_ratio = LL_yes / LL_total
  )

# 95 % CI

LL_summary_cl <- LL_summary_cl %>%
  rowwise() %>%
  mutate(
    conf_int = list(binom.test(LL_yes, LL_total)$conf.int),
    lower_ci = conf_int[[1]],
    upper_ci = conf_int[[2]]
  ) %>%
  ungroup()


```


```{r}
LLlc <- ggplot(LL_summary_cl, aes(x = loser_ioc, y = LL_ratio)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(title = "Prevalence of Lucky loser by age with 95% Confidence Interval", 
       x = "Loser ioc", 
       y = "Prevalence (LL = Yes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
   scale_y_continuous(limits = c(0, 1)) 

LLlc

```

# 3. Percentaje per tourney

Check if there is any match with two LL or PR, or LL and PR

```{r}

# 2 LL
cond1 <- datos_combinados$LLW == 1 & datos_combinados$LLL == 1

# 2 PR
cond2 <- datos_combinados$PRW == 1 & datos_combinados$PRL == 1

# 1 PR and 1 LL
cond3 <- (datos_combinados$PRW == 1 | datos_combinados$LLL == 1) &
         (datos_combinados$LLW == 1 | datos_combinados$PRL == 1)

partidos_double_LL_and_or_PR <- datos_combinados %>%
  filter(cond1 | cond2 | cond3)

head(partidos_double_LL_and_or_PR)
summary(partidos_double_LL_and_or_PR)


```

There are 45 matches with a LL/PR or two of them. 

### For LL 

```{r}

unique_ll_per_tournament <- datos_combinados %>%
  select(tourney_id, winner_id, loser_id, LLW, LLL) %>%
  pivot_longer(cols = c(winner_id, loser_id), names_to = "player_type", values_to = "player_id") %>%
  # Keep only matches where players are LL
  filter((player_type == "winner_id" & LLW == 1) | (player_type == "loser_id" & LLL == 1)) %>%
  # Group by tournament and count unique LL players
  group_by(tourney_id) %>%
  summarise(unique_LL_count = n_distinct(player_id)) %>%
  ungroup()



sum(unique_ll_per_tournament$unique_LL_count)
n_distinct(unique_ll_per_tournament$tourney_id)
n_distinct(datos_combinados$tourney_id)


Tournaments_with_LL <- n_distinct(unique_ll_per_tournament$tourney_id)*100/n_distinct(datos_combinados$tourney_id)
Tournaments_with_LL

binom.test(sum(unique_ll_per_tournament$unique_LL_count), n_distinct(datos_combinados$tourney_id), conf.level = 0.95)


```



### For PR

```{r}

# Create a new dataframe that counts unique PR per tournament
unique_pr_per_tournament <- datos_combinados %>%
  # Create a temporary dataframe to identify PR players in each match
  select(tourney_id, winner_id, loser_id, PRW, PRL) %>%
  pivot_longer(cols = c(winner_id, loser_id), names_to = "player_type", values_to = "player_id") %>%
  # Keep only matches where players are PR
  filter((player_type == "winner_id" & PRW == 1) | (player_type == "loser_id" & PRL == 1)) %>%
  # Group by tournament and count unique PR players
  group_by(tourney_id) %>%
  summarise(unique_PR_count = n_distinct(player_id)) %>%
  ungroup()



sum(unique_pr_per_tournament$unique_PR_count)
n_distinct(unique_pr_per_tournament$tourney_id)
n_distinct(datos_combinados$tourney_id)


Tournaments_with_PR <- n_distinct(unique_pr_per_tournament$tourney_id)*100/n_distinct(datos_combinados$tourney_id)
Tournaments_with_PR

binom.test(sum(unique_pr_per_tournament$unique_PR_count), n_distinct(datos_combinados$tourney_id), conf.level = 0.95)


```


# 4. Winer/loser new variable

```{r}
#LL
datos_combinados <- datos_combinados %>%
  mutate(
    LL_wins = case_when(
      winner_entry == "LL" ~ 1,
      loser_entry == "LL" ~ 0,
      TRUE ~ NA_real_
    ),
    LL_loses = case_when(
      loser_entry == "LL" ~ 1,
      winner_entry == "LL" ~ 0,
      TRUE ~ NA_real_
    )
  )

#PR
datos_combinados <- datos_combinados %>%
  mutate(
    PR_wins = case_when(
      winner_entry == "PR" ~ 1,
      loser_entry == "PR" ~ 0,
      TRUE ~ NA_real_
    ),
    PR_loses = case_when(
      loser_entry == "PR" ~ 1,
      winner_entry == "PR" ~ 0,
      TRUE ~ NA_real_
    )
  )


```

## Comparing groups

```{r}
compareGroups(LL_wins ~ ., method = NA, data = datos_combinados)
compareGroups(LL_loses ~ ., method = NA, data = datos_combinados)


compareGroups(PR_wins ~ ., method = NA, data = datos_combinados)
compareGroups(PR_loses ~ ., method = NA, data = datos_combinados)

```

# 5. Special entries matches 

```{r}
library(dplyr)

categorize_match <- function(winner_entry, loser_entry) {
  if (grepl("LL", winner_entry) & grepl("LL", loser_entry)) {
    return("LL & LL")
  } else if ((grepl("LL", winner_entry) & grepl("PR", loser_entry)) | 
             (grepl("PR", winner_entry) & grepl("LL", loser_entry))) {
    return("LL & PR")
  } else if (grepl("PR", winner_entry) & grepl("PR", loser_entry)) {
    return("PR & PR")
  }
}

datos_combinados <- datos_combinados %>%
  mutate(match_type = mapply(categorize_match, winner_entry, loser_entry))

table_summary <- datos_combinados %>%
  group_by(match_type) %>%
  summarize(nmatches = n())

table_summary <- table_summary %>%
  select(match_type, nmatches) %>%
  pivot_wider(names_from = match_type, values_from = nmatches, 
              values_fill = list(nmatches = 0))

table_summary <- rename(table_summary, 
                       `Lucky Loser` = `LL & LL`, 
                       `Protected Ranking` = `PR & PR`, 
                       `LL & PR` = `LL & PR`)

table_summary

```


# 6. Summary 



```{r}
library(gtsummary)

tbl_summary(data = datos_combinados, by = PR, include = c(year, surface, tourney_level, winner_hand, loser_hand, dif_age, winner_rank, loser_rank))


tbl_summary(data = datos_combinados, by = LL, include = c(year, surface, tourney_level, winner_hand, loser_hand, dif_age, winner_rank, loser_rank))



```

# 7. Graphics


# Raincloud plot 

## dig_age

```{r, eval= FALSE}

library(ggplot2)
library(ggdist)
library(gghalves)

ggplot(datos_combinados, aes(x = LL, y = dif_age)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")





ggplot(datos_combinados, aes(x = PR, y = dif_age)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

```

```{r}

# Load necessary libraries
library(ggplot2)
library(ggdist)
library(gghalves)
library(patchwork)

# Create the first plot (LL)
plot_LL <- ggplot(datos_combinados, aes(x = LL, y = dif_age)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  gghalves::geom_half_point(
    side = "l", 
    range_scale = .4, 
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

# Create the second plot (PR)
plot_PR <- ggplot(datos_combinados, aes(x = PR, y = dif_age)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  gghalves::geom_half_point(
    side = "l", 
    range_scale = .4, 
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

# Combine the plots
combined_plot <- plot_LL + plot_PR

# Save the combined plot as a TIFF file
ggsave("combined_plot.tiff", plot = combined_plot, width = 12, height = 6, dpi = 300, device = "tiff")

```


## Rank diference


```{r, eval= FALSE}

# Create the LL plot for dif_rank
plot_LL_dif_rank <- ggplot(datos_combinados, aes(x = LL, y = dif_rank)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  gghalves::geom_half_point(
    side = "l", 
    range_scale = .4, 
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

# Create the PR plot for dif_rank
plot_PR_dif_rank <- ggplot(datos_combinados, aes(x = PR, y = dif_rank)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  gghalves::geom_half_point(
    side = "l", 
    range_scale = .4, 
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

# Combine both plots side by side
combined_dif_rank_plot <- plot_LL_dif_rank + plot_PR_dif_rank

# Save the combined plot as a TIFF file
ggsave("combined_dif_rank_plot.tiff", plot = combined_dif_rank_plot, width = 12, height = 6, dpi = 300, device = "tiff")


```






## Age AND Rank differnce

```{r, eval= FALSE}
ggplot(datos_combinados, aes(x = dif_rank, y = dif_age, color = factor(LL))) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  gghalves::geom_half_point(
    side = "l", 
    range_scale = .4, 
    alpha = .2
  ) +
  facet_wrap(~ LL, scales = "free", labeller = labeller(LL = c(`0` = "No", `1` = "Yes"))) +
  labs(
    x = "Difference in Rank",
    y = "Difference in Age",
    color = "Match Outcome"
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal()

```



## Surface




```{r, eval= FALSE}

ggplot(datos_combinados, aes(x = LL, y = surface)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")





ggplot(datos_combinados, aes(x = PR, y = surface)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

```

```{r}

plot_LL_surface <- ggplot(datos_combinados, aes(x = LL, y = surface)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")





plot_PR_surface <- ggplot(datos_combinados, aes(x = PR, y = surface)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")



# Combine both plots using patchwork
combined_surface_plot <- plot_LL_surface + plot_PR_surface

# Save the combined plot as a TIFF file
ggsave("combined_surface_plot.tiff", plot = combined_surface_plot, width = 12, height = 6, dpi = 300, device = "tiff")

```






## Tourney level



```{r, eval= FALSE}

ggplot(datos_combinados, aes(x = LL, y = tourney_level)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")





ggplot(datos_combinados, aes(x = PR, y = tourney_level)) + 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .2
  ) +
  coord_cartesian(xlim = c(1.2, 2.9), clip = "off")

```


# 8. Epi2by2


## LL 


```{r}
library(epiR)



# Surface. Reference: Grass
(tabla_surface_LL <- table(datos_combinados$surface, datos_combinados$LL))

Valores_Grass_Clay_LL <- c(tabla_surface_LL["Clay", "Yes"], tabla_surface_LL["Clay", "No"], 
                           tabla_surface_LL["Grass", "Yes"], tabla_surface_LL["Grass", "No"])


epi.2by2(
  dat = Valores_Grass_Clay_LL,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)



Valores_Grass_Hard_LL <- c(tabla_surface_LL["Hard", "Yes"], tabla_surface_LL["Hard", "No"], 
                           tabla_surface_LL["Grass", "Yes"], tabla_surface_LL["Grass", "No"])
  
epi.2by2(
  dat = Valores_Grass_Hard_LL,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)
                            

Valores_Grass_Carpet_LL <- c(tabla_surface_LL["Carpet", "Yes"], tabla_surface_LL["Carpet", "No"], 
                           tabla_surface_LL["Grass", "Yes"], tabla_surface_LL["Grass", "No"])
  
epi.2by2(
  dat = Valores_Grass_Carpet_LL,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)




# Round level. Reference: Final

(tabla_round_LL <- table(datos_combinados$round, datos_combinados$LL))

## "R32"  "R16"  "R64"  "R128" "BR"   "RR"   "ER" are included as preliminary

Valores_Prel_F_LL <- c(tabla_round_LL["R32", "Yes"] + tabla_round_LL["R16", "Yes"] +
                         tabla_round_LL["R64", "Yes"] + tabla_round_LL["R128", "Yes"] +
                         tabla_round_LL["RR", "Yes"] + tabla_round_LL["BR", "Yes"] + tabla_round_LL["ER", "Yes"],
                      tabla_round_LL["R32", "No"] + tabla_round_LL["R16", "No"] +
                         tabla_round_LL["R64", "No"] + tabla_round_LL["R128", "No"] +
                         tabla_round_LL["RR", "No"] + tabla_round_LL["BR", "No"] + tabla_round_LL["ER", "No"], 
                           tabla_round_LL["F", "Yes"], tabla_round_LL["F", "No"])


epi.2by2(
  dat = Valores_Prel_F_LL,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)


Valores_F_SF_LL <- c(tabla_round_LL["SF", "Yes"], tabla_round_LL["SF", "No"], 
                           tabla_round_LL["F", "Yes"], tabla_round_LL["F", "No"])
  
epi.2by2(
  dat = Valores_F_SF_LL ,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)

Valores_F_QF_LL <- c(tabla_round_LL["QF", "Yes"], tabla_round_LL["QF", "No"], 
                           tabla_round_LL["F", "Yes"], tabla_round_LL["F", "No"])
  
epi.2by2(
  dat = Valores_F_QF_LL ,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)



# tourney_level Reference: Masters
(tabla_tourney_level_LL <- table(datos_combinados$tourney_level, datos_combinados$LL))


Valores_M_A_LL <- c(tabla_tourney_level_LL["A", "Yes"], tabla_tourney_level_LL["A", "No"], tabla_tourney_level_LL["M", "Yes"], tabla_tourney_level_LL["M", "No"])

epi.2by2(dat = Valores_M_A_LL, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")



Valores_M_G_LL <- c(tabla_tourney_level_LL["G", "Yes"], tabla_tourney_level_LL["G", "No"], tabla_tourney_level_LL["M", "Yes"], tabla_tourney_level_LL["M", "No"])
epi.2by2(dat = Valores_M_G_LL, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")


Valores_M_F_LL <- c(tabla_tourney_level_LL["F", "Yes"], tabla_tourney_level_LL["F", "No"], tabla_tourney_level_LL["M", "Yes"], tabla_tourney_level_LL["M", "No"])
epi.2by2(dat = Valores_M_F_LL, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")



# LL and Winner Hand. Reference: Left
(table_LL_winner_hand <- table(datos_combinados$LL, datos_combinados$winner_hand))


Valores_winner_hand <- c(table_LL_winner_hand["Yes", "R"], table_LL_winner_hand["No", "R"], table_LL_winner_hand["Yes", "L"], table_LL_winner_hand["No", "L"])
epi.2by2(Valores_winner_hand , 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")


# LL and Loser Hand. Refrence: Left

(table_LL_loser_hand <- table(datos_combinados$LL, datos_combinados$loser_hand))

Valores_loser_hand <- c(table_LL_loser_hand["Yes", "R"], table_LL_loser_hand["No", "R"], table_LL_loser_hand["Yes", "L"], table_LL_loser_hand["No", "L"])
epi.2by2(Valores_loser_hand, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")
```


## PR 


```{r}



# Surface. Reference: Grass
(tabla_surface_PR <- table(datos_combinados$surface, datos_combinados$PR))

Valores_Grass_Clay_PR <- c(tabla_surface_PR["Clay", "Yes"], tabla_surface_PR["Clay", "No"], 
                           tabla_surface_PR["Grass", "Yes"], tabla_surface_PR["Grass", "No"])


epi.2by2(
  dat = Valores_Grass_Clay_PR,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)



Valores_Grass_Hard_PR <- c(tabla_surface_PR["Hard", "Yes"], tabla_surface_PR["Hard", "No"], 
                           tabla_surface_PR["Grass", "Yes"], tabla_surface_PR["Grass", "No"])
  
epi.2by2(
  dat = Valores_Grass_Hard_PR,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)
                            

Valores_Grass_Carpet_PR <- c(tabla_surface_PR["Carpet", "Yes"], tabla_surface_PR["Carpet", "No"], 
                           tabla_surface_PR["Grass", "Yes"], tabla_surface_PR["Grass", "No"])
  
epi.2by2(
  dat = Valores_Grass_Carpet_PR,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)




# Round level. Reference: Final

(tabla_round_PR <- table(datos_combinados$round, datos_combinados$PR))

## "R32"  "R16"  "R64"  "R128" "BR"   "RR"   "ER" are included as preliminary

Valores_Prel_F_PR <- c(tabla_round_PR["R32", "Yes"] + tabla_round_PR["R16", "Yes"] +
                         tabla_round_PR["R64", "Yes"] + tabla_round_PR["R128", "Yes"] +
                         tabla_round_PR["RR", "Yes"] + tabla_round_PR["BR", "Yes"] + tabla_round_PR["ER", "Yes"],
                      tabla_round_PR["R32", "No"] + tabla_round_PR["R16", "No"] +
                         tabla_round_PR["R64", "No"] + tabla_round_PR["R128", "No"] +
                         tabla_round_PR["RR", "No"] + tabla_round_PR["BR", "No"] + tabla_round_PR["ER", "No"], 
                           tabla_round_PR["F", "Yes"], tabla_round_PR["F", "No"])


epi.2by2(
  dat = Valores_Prel_F_PR,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)


Valores_F_SF_PR <- c(tabla_round_PR["SF", "Yes"], tabla_round_PR["SF", "No"], 
                           tabla_round_PR["F", "Yes"], tabla_round_PR["F", "No"])
  
epi.2by2(
  dat = Valores_F_SF_PR ,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)

Valores_F_QF_PR <- c(tabla_round_PR["QF", "Yes"], tabla_round_PR["QF", "No"], 
                           tabla_round_PR["F", "Yes"], tabla_round_PR["F", "No"])
  
epi.2by2(
  dat = Valores_F_QF_PR ,
  method = "cohort.count", 
  digits = 2, 
  conf.level = 0.95, 
  units = 1000, 
  interpret = FALSE, 
  outcome = "as.columns"
)



# tourney_level Reference: Masters
(tabla_tourney_level_PR <- table(datos_combinados$tourney_level, datos_combinados$PR))


Valores_M_A_PR <- c(tabla_tourney_level_PR["A", "Yes"], tabla_tourney_level_PR["A", "No"], tabla_tourney_level_PR["M", "Yes"], tabla_tourney_level_PR["M", "No"])

epi.2by2(dat = Valores_M_A_PR, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")



Valores_M_G_PR <- c(tabla_tourney_level_PR["G", "Yes"], tabla_tourney_level_PR["G", "No"], tabla_tourney_level_PR["M", "Yes"], tabla_tourney_level_PR["M", "No"])
epi.2by2(dat = Valores_M_G_PR, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")


Valores_M_F_PR <- c(tabla_tourney_level_PR["F", "Yes"], tabla_tourney_level_PR["F", "No"], tabla_tourney_level_PR["M", "Yes"], tabla_tourney_level_PR["M", "No"])
epi.2by2(dat = Valores_M_F_PR, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")



# PR and Winner Hand. Reference: Left
(table_PR_winner_hand <- table(datos_combinados$PR, datos_combinados$winner_hand))


Valores_winner_hand <- c(table_PR_winner_hand["Yes", "R"], table_PR_winner_hand["No", "R"], table_PR_winner_hand["Yes", "L"], table_PR_winner_hand["No", "L"])
epi.2by2(Valores_winner_hand , 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")


# PR and Loser Hand. Refrence: Left

(table_PR_loser_hand <- table(datos_combinados$PR, datos_combinados$loser_hand))

Valores_loser_hand <- c(table_PR_loser_hand["Yes", "R"], table_PR_loser_hand["No", "R"], table_PR_loser_hand["Yes", "L"], table_PR_loser_hand["No", "L"])
epi.2by2(Valores_loser_hand, 
                           method = "cohort.time", 
                           digits = 2, 
                           conf.level = 0.95, 
                           units = 1000,
                           interpret = FALSE, 
                           outcome = "as.columns")
```


